---
---
<div class="screen" id="resultsScreen">
    <div class="card results-container">
        <h2 style="color:var(--text-secondary)">Challenge Complete!</h2>
        <div class="results-score" id="finalScore">0%</div>
        <div class="results-grade" id="finalGrade">-</div>

        <div class="results-stats">
            <div class="result-stat">
                <div class="result-stat-value" id="correctCount">0</div>
                <div class="result-stat-label">Correct</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-value" id="incorrectCount">0</div>
                <div class="result-stat-label">Incorrect</div>
            </div>
            <div class="result-stat">
                <div class="result-stat-value" id="finalTime">00:00</div>
                <div class="result-stat-label">Time</div>
            </div>
        </div>

        <div style="margin-top:30px">
            <button class="btn btn-primary" onclick="window.game.showReview()">Review Answers</button>
            <button class="btn btn-secondary" onclick="window.game.goHome()" style="margin-left:10px">Back to Home</button>
        </div>
    </div>

    <div class="card" id="reviewContainer" style="display:none">
        <h3 style="margin-bottom:20px">Answer Review</h3>
        <div id="reviewContent"></div>
    </div>
</div>
</div>

<script>
    export interface QuizResults {
        score: number;
        total: number;
        time: number;
        answers: any[];
        maxStreak: number;
    }

    class ResultsScreenController {
        constructor() {
            // @ts-ignore
            window.game = window.game || {};
            // @ts-ignore
            window.game.showResults = this.display.bind(this);
            // @ts-ignore
            window.game.showReview = this.showReview.bind(this);
        }

        display(results: QuizResults): void {
            this.showScreen('resultsScreen');

            const percentage = Math.round((results.score / results.total) * 100);
            
            // Store results temporarily for review button access if needed, or pass it via closure/global
             // @ts-ignore
            window.lastQuizResults = results;

            const elFinalScore = document.getElementById('finalScore');
            if (elFinalScore) elFinalScore.textContent = percentage + '%';

            const elCorrect = document.getElementById('correctCount');
            if (elCorrect) elCorrect.textContent = results.score.toString();

            const elIncorrect = document.getElementById('incorrectCount');
            if (elIncorrect) elIncorrect.textContent = (results.total - results.score).toString();

            const elTime = document.getElementById('finalTime');
            if (elTime) elTime.textContent = this.formatTime(results.time);

            const elGrade = document.getElementById('finalGrade');
            if (elGrade) elGrade.textContent = this.getGrade(percentage);
        }

        showScreen(id: string) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id)?.classList.add('active');
        }

        showReview(): void {
            // @ts-ignore
            const results = window.lastQuizResults;
            if(!results) return;

            const container = document.getElementById('reviewContainer') as HTMLElement;
            if (container) container.style.display = 'block';

            const content = document.getElementById('reviewContent');
            if (content) {
                content.innerHTML = results.answers.map((ans: any, idx: number) => `
                    <div class="review-item ${ans.correct ? 'review-correct' : 'review-incorrect'}">
                        <div class="review-question">${idx + 1}. ${ans.question}</div>
                        <div class="review-answer">Your Answer: ${JSON.stringify(ans.userAnswer)}</div>
                        <div class="review-answer">Correct: ${JSON.stringify(ans.correctAnswer)}</div>
                        <div class="review-answer" style="margin-top:5px;font-style:italic">${ans.explanation}</div>
                    </div>
                `).join('');
            }
        }

        private getGrade(score: number): string {
            if (score >= 97) return 'S+';
            if (score >= 93) return 'S';
            if (score >= 90) return 'A+';
            if (score >= 87) return 'A';
            if (score >= 80) return 'B+';
            if (score >= 70) return 'C+';
            if (score >= 60) return 'D+';
            return 'F';
        }

        private formatTime(secs: number): string {
            const m = Math.floor(secs / 60);
            const s = secs % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new ResultsScreenController();
    });
</script>
